# =============================================================================
# RepoLens GitLab CI/CD Integration Template
# =============================================================================
#
# This template provides a ready-to-use GitLab CI/CD configuration for running
# RepoLens audits on your repository.
#
# USAGE:
# 1. Copy this file to your repository root as `.gitlab-ci.yml`
# 2. Customize the variables and settings as needed
# 3. Commit and push to trigger the pipeline
#
# REQUIREMENTS:
# - GitLab CI/CD enabled on your repository
# - Docker executor available (for Docker-based approach)
# - OR: Shell executor with RepoLens binary installed
#
# =============================================================================

# Global variables - customize these for your project
variables:
  # RepoLens version to use (use 'latest' for the most recent stable release)
  REPOLENS_VERSION: "latest"
  # Audit preset: opensource, enterprise, or strict
  REPOLENS_PRESET: "opensource"
  # Output format: terminal, json, sarif, markdown, html
  REPOLENS_FORMAT: "json"
  # Fail on severity level: critical, high, medium, low, none
  REPOLENS_FAIL_ON: "critical"

# Define pipeline stages
stages:
  - audit

# =============================================================================
# Option 1: Docker-based RepoLens Audit (Recommended)
# =============================================================================
# Uses the official RepoLens Docker image for consistent results across
# different runners and environments.

repolens-audit:
  stage: audit
  image: ghcr.io/delfour-co/repolens:${REPOLENS_VERSION}

  # Cache dependencies and RepoLens cache for faster subsequent runs
  cache:
    key: repolens-cache-${CI_COMMIT_REF_SLUG}
    paths:
      - .repolens/cache/
    policy: pull-push

  # Run before the main script
  before_script:
    - repolens --version

  # Main audit script
  script:
    # Run RepoLens audit and generate report
    - |
      repolens plan \
        --preset ${REPOLENS_PRESET} \
        --format ${REPOLENS_FORMAT} \
        --output audit-report.${REPOLENS_FORMAT}

  # Save audit reports as artifacts
  artifacts:
    # Use GitLab's Code Quality report format for merge request integration
    reports:
      codequality: audit-report.json
    # Also keep the raw report file
    paths:
      - audit-report.*
    expire_in: 30 days
    when: always

  # Run on merge requests and default branch
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on the default branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    # Allow manual trigger on any branch
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual

  # Allow the job to fail without blocking the pipeline
  # Set to false for stricter enforcement
  allow_failure: false

# =============================================================================
# Option 2: Binary Installation Approach
# =============================================================================
# Downloads and installs RepoLens binary directly. Useful when Docker is
# not available or for more control over the installation process.

.repolens-audit-binary:
  stage: audit
  image: ubuntu:22.04

  # Cache the binary to speed up subsequent runs
  cache:
    key: repolens-binary-${REPOLENS_VERSION}
    paths:
      - /usr/local/bin/repolens
    policy: pull-push

  before_script:
    # Install required tools
    - apt-get update && apt-get install -y curl git

    # Determine the version to install
    - |
      if [ "${REPOLENS_VERSION}" = "latest" ]; then
        VERSION=$(curl -s https://api.github.com/repos/delfour-co/cli--repolens/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
      else
        VERSION="${REPOLENS_VERSION}"
      fi
      echo "Installing RepoLens version: ${VERSION}"

    # Download and install RepoLens (if not cached)
    - |
      if [ ! -f /usr/local/bin/repolens ]; then
        curl -LO "https://github.com/delfour-co/cli--repolens/releases/download/v${VERSION}/repolens-linux-x86_64.tar.gz"
        tar xzf repolens-linux-x86_64.tar.gz
        mv repolens /usr/local/bin/
        rm repolens-linux-x86_64.tar.gz
      fi

    # Verify installation
    - repolens --version

  script:
    - |
      repolens plan \
        --preset ${REPOLENS_PRESET} \
        --format ${REPOLENS_FORMAT} \
        --output audit-report.${REPOLENS_FORMAT}

  artifacts:
    reports:
      codequality: audit-report.json
    paths:
      - audit-report.*
    expire_in: 30 days
    when: always

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Optional: SARIF Upload for GitLab Security Dashboard
# =============================================================================
# Generates SARIF output for integration with GitLab's security features.
# Requires GitLab Ultimate tier.

.repolens-security-scan:
  stage: audit
  image: ghcr.io/delfour-co/repolens:${REPOLENS_VERSION}

  script:
    - repolens plan --preset ${REPOLENS_PRESET} --format sarif --output gl-sast-report.json

  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - gl-sast-report.json
    expire_in: 30 days
    when: always

  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Optional: Scheduled Nightly Audit
# =============================================================================
# Runs a comprehensive audit on a schedule (configure via GitLab CI/CD settings).

.repolens-nightly:
  stage: audit
  image: ghcr.io/delfour-co/repolens:${REPOLENS_VERSION}

  variables:
    # Use strict preset for nightly audits
    REPOLENS_PRESET: "strict"
    REPOLENS_FORMAT: "html"

  script:
    - repolens plan --preset ${REPOLENS_PRESET} --format ${REPOLENS_FORMAT} --output audit-report.html
    - repolens plan --preset ${REPOLENS_PRESET} --format json --output audit-report.json

  artifacts:
    paths:
      - audit-report.html
      - audit-report.json
    expire_in: 90 days
    when: always

  rules:
    # Only run on scheduled pipelines
    - if: $CI_PIPELINE_SOURCE == "schedule"
