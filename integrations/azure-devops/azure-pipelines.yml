# =============================================================================
# RepoLens Azure DevOps Pipelines Template
# =============================================================================
#
# This template provides a ready-to-use Azure Pipelines configuration for
# running RepoLens audits on your repository.
#
# USAGE:
# 1. Copy this file to your repository root as `azure-pipelines.yml`
# 2. Customize the variables and settings as needed
# 3. Create a pipeline in Azure DevOps pointing to this file
#
# REQUIREMENTS:
# - Azure DevOps project with Pipelines enabled
# - Docker support on agents (for container jobs)
# - OR: Ubuntu agent for binary installation
#
# =============================================================================

# Trigger configuration
trigger:
  branches:
    include:
      - main
      - develop
      - release/*
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

# Pull request trigger
pr:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

# Scheduled runs
schedules:
  - cron: '0 2 * * *'  # Run at 2 AM UTC every day
    displayName: 'Nightly Audit'
    branches:
      include:
        - main
    always: true

# Pipeline variables
variables:
  # RepoLens configuration
  repolensVersion: 'latest'
  repolensPreset: 'opensource'
  repolensFormat: 'json'
  repolensFailOn: 'critical'

  # Report paths
  reportDir: '$(Build.ArtifactStagingDirectory)/repolens-reports'

# =============================================================================
# Stage: Audit
# =============================================================================

stages:
  - stage: Audit
    displayName: 'RepoLens Audit'
    jobs:
      # =======================================================================
      # Job: Docker-based Audit (Recommended)
      # =======================================================================
      - job: AuditDocker
        displayName: 'Audit (Docker)'
        pool:
          vmImage: 'ubuntu-latest'

        container:
          image: ghcr.io/delfour-co/repolens:$(repolensVersion)

        steps:
          - checkout: self
            fetchDepth: 1

          - script: |
              mkdir -p $(reportDir)
              repolens --version
            displayName: 'Setup'

          - script: |
              # Determine file extension
              FORMAT=$(repolensFormat)
              case "${FORMAT}" in
                json)     EXT="json" ;;
                sarif)    EXT="sarif" ;;
                markdown) EXT="md" ;;
                html)     EXT="html" ;;
                *)        EXT="txt" ;;
              esac

              # Run RepoLens audit
              repolens plan \
                --preset $(repolensPreset) \
                --format ${FORMAT} \
                --output $(reportDir)/audit-report.${EXT}

              # Store exit code
              AUDIT_EXIT_CODE=$?
              echo "##vso[task.setvariable variable=auditExitCode]${AUDIT_EXIT_CODE}"

              # Handle fail-on logic
              FAIL_ON="$(repolensFailOn)"
              if [ "${FAIL_ON}" = "none" ]; then
                echo "fail-on is set to 'none', ignoring exit code"
                exit 0
              fi

              if [ ${AUDIT_EXIT_CODE} -ne 0 ]; then
                case "${FAIL_ON}" in
                  critical)
                    if [ ${AUDIT_EXIT_CODE} -eq 1 ]; then
                      echo "##vso[task.logissue type=error]Critical findings detected"
                      exit 1
                    fi
                    ;;
                  high|medium|low)
                    echo "##vso[task.logissue type=error]Findings detected at or above '${FAIL_ON}' severity"
                    exit 1
                    ;;
                esac
              fi
            displayName: 'Run RepoLens Audit'
            continueOnError: false

          # Generate additional formats
          - script: |
              repolens plan \
                --preset $(repolensPreset) \
                --format html \
                --output $(reportDir)/audit-report.html
            displayName: 'Generate HTML Report'
            condition: ne(variables['repolensFormat'], 'html')

          - script: |
              repolens plan \
                --preset $(repolensPreset) \
                --format sarif \
                --output $(reportDir)/audit-report.sarif
            displayName: 'Generate SARIF Report'
            condition: ne(variables['repolensFormat'], 'sarif')

          # Publish artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Reports'
            inputs:
              pathToPublish: '$(reportDir)'
              artifactName: 'RepoLens-Reports'
              publishLocation: 'Container'
            condition: always()

          # Publish test results (SARIF format)
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            inputs:
              testResultsFormat: 'NUnit'
              testResultsFiles: '$(reportDir)/audit-report.json'
              mergeTestResults: true
              failTaskOnFailedTests: false
              testRunTitle: 'RepoLens Audit Results'
            condition: always()
            continueOnError: true

      # =======================================================================
      # Job: Binary Installation (Alternative)
      # =======================================================================
      - job: AuditBinary
        displayName: 'Audit (Binary)'
        condition: false  # Disabled by default; enable if Docker is not available
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - checkout: self
            fetchDepth: 1

          - script: |
              VERSION="$(repolensVersion)"
              if [ "${VERSION}" = "latest" ]; then
                VERSION=$(curl -s https://api.github.com/repos/delfour-co/cli--repolens/releases/latest | grep '"tag_name"' | sed -E 's/.*"v([^"]+)".*/\1/')
              fi
              echo "Installing RepoLens version: ${VERSION}"

              curl -LO "https://github.com/delfour-co/cli--repolens/releases/download/v${VERSION}/repolens-linux-x86_64.tar.gz"
              tar xzf repolens-linux-x86_64.tar.gz
              sudo mv repolens /usr/local/bin/
              rm repolens-linux-x86_64.tar.gz

              repolens --version
            displayName: 'Install RepoLens'

          - script: |
              mkdir -p $(reportDir)
              repolens plan \
                --preset $(repolensPreset) \
                --format $(repolensFormat) \
                --output $(reportDir)/audit-report.$(repolensFormat)
            displayName: 'Run RepoLens Audit'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Reports'
            inputs:
              pathToPublish: '$(reportDir)'
              artifactName: 'RepoLens-Reports'
              publishLocation: 'Container'
            condition: always()

# =============================================================================
# Template: Reusable Audit Template
# =============================================================================
# Save this as a template in your Azure DevOps organization for reuse
# across multiple projects.
#
# Usage in another pipeline:
#
# stages:
#   - template: templates/repolens-audit.yml
#     parameters:
#       preset: 'enterprise'
#       format: 'sarif'
#       failOn: 'high'
#
# Template file (templates/repolens-audit.yml):
#
# parameters:
#   - name: preset
#     type: string
#     default: 'opensource'
#   - name: format
#     type: string
#     default: 'json'
#   - name: failOn
#     type: string
#     default: 'critical'
#   - name: version
#     type: string
#     default: 'latest'
#
# stages:
#   - stage: RepoLensAudit
#     displayName: 'RepoLens Audit'
#     jobs:
#       - job: Audit
#         pool:
#           vmImage: 'ubuntu-latest'
#         container:
#           image: ghcr.io/delfour-co/repolens:${{ parameters.version }}
#         steps:
#           - checkout: self
#           - script: |
#               repolens plan \
#                 --preset ${{ parameters.preset }} \
#                 --format ${{ parameters.format }} \
#                 --output audit-report.${{ parameters.format }}
#             displayName: 'Run Audit'
#           - publish: audit-report.${{ parameters.format }}
#             artifact: RepoLens-Report

# =============================================================================
# PR Decoration (Optional)
# =============================================================================
# To add comments to pull requests with audit results, add the following task
# after the audit step (requires Azure DevOps REST API permissions):
#
# - task: PowerShell@2
#   displayName: 'Post PR Comment'
#   condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
#   inputs:
#     targetType: 'inline'
#     script: |
#       $reportContent = Get-Content $(reportDir)/audit-report.md -Raw
#       $comment = @{
#         comments = @(@{
#           parentCommentId = 0
#           content = $reportContent
#           commentType = 1
#         })
#         status = 1
#       }
#
#       $uri = "$(System.CollectionUri)$(System.TeamProject)/_apis/git/repositories/$(Build.Repository.ID)/pullRequests/$(System.PullRequest.PullRequestId)/threads?api-version=7.0"
#
#       Invoke-RestMethod -Uri $uri -Method Post -Body ($comment | ConvertTo-Json -Depth 10) -ContentType "application/json" -Headers @{
#         Authorization = "Bearer $(System.AccessToken)"
#       }
