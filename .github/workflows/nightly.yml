name: Nightly Build

on:
  # Déclenché tous les soirs à 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # Déclenchement manuel possible
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # Vérification des pré-requis avant de lancer le build
  check-prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      last_nightly_sha: ${{ steps.check.outputs.last_nightly_sha }}
      current_sha: ${{ steps.check.outputs.current_sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes and CI status
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          CURRENT_SHA=$(git rev-parse HEAD)
          echo "current_sha=${CURRENT_SHA}" >> $GITHUB_OUTPUT
          echo "Current commit: ${CURRENT_SHA}"

          # Trouver le dernier tag nightly
          LAST_NIGHTLY_TAG=$(git tag -l 'nightly-*' --sort=-creatordate | head -1)

          if [ -z "$LAST_NIGHTLY_TAG" ]; then
            echo "No previous nightly tag found. Will build."
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "last_nightly_sha=" >> $GITHUB_OUTPUT
          else
            LAST_NIGHTLY_SHA=$(git rev-list -n 1 "$LAST_NIGHTLY_TAG")
            echo "last_nightly_sha=${LAST_NIGHTLY_SHA}" >> $GITHUB_OUTPUT
            echo "Last nightly tag: ${LAST_NIGHTLY_TAG} (${LAST_NIGHTLY_SHA})"

            # Vérifier s'il y a des changements
            CHANGES=$(git rev-list ${LAST_NIGHTLY_SHA}..HEAD --count)
            echo "Changes since last nightly: ${CHANGES} commits"

            if [ "$CHANGES" -eq "0" ]; then
              echo "No changes since last nightly. Skipping build."
              echo "should_build=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Vérifier le statut du dernier workflow CI
          echo "Checking CI workflow status..."
          CI_STATUS=$(gh run list --workflow=ci.yml --branch=main --limit=1 --json conclusion --jq '.[0].conclusion')
          echo "CI status: ${CI_STATUS}"

          if [ "$CI_STATUS" != "success" ]; then
            echo "CI workflow did not succeed (status: ${CI_STATUS}). Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Vérifier le statut du dernier workflow Code Quality
          echo "Checking Code Quality workflow status..."
          CQ_STATUS=$(gh run list --workflow=code-quality.yml --branch=main --limit=1 --json conclusion --jq '.[0].conclusion')
          echo "Code Quality status: ${CQ_STATUS}"

          if [ "$CQ_STATUS" != "success" ]; then
            echo "Code Quality workflow did not succeed (status: ${CQ_STATUS}). Skipping build."
            echo "should_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "All checks passed. Will build nightly."
          echo "should_build=true" >> $GITHUB_OUTPUT

  # Vérification des seuils de qualité
  quality-gates:
    name: Quality Gates Check
    runs-on: ubuntu-latest
    needs: [check-prerequisites]
    if: needs.check-prerequisites.outputs.should_build == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install required tools
        run: |
          cargo install cargo-tarpaulin cargo-audit cargo-outdated cargo-deny --locked || true

      - name: Run tests with coverage
        run: |
          cargo tarpaulin --out Xml --output-dir coverage --all-features || true

      - name: Run Clippy
        run: |
          cargo clippy --all-targets --all-features --message-format=json > clippy.json || true

      - name: Run security audit
        run: |
          cargo audit --json > audit.json || true

      - name: Check outdated dependencies
        run: |
          cargo outdated --format json > outdated.json || true

      - name: Build project (for binary size check)
        run: |
          cargo build --release --locked || true

      - name: Check quality gates
        run: |
          chmod +x scripts/check-quality-gates.sh
          ./scripts/check-quality-gates.sh coverage/cobertura.xml clippy.json audit.json || exit 1

  # Build nightly
  build:
    name: Build Nightly
    runs-on: ubuntu-latest
    needs: [check-prerequisites, quality-gates]
    if: needs.check-prerequisites.outputs.should_build == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Get version info
        id: version
        run: |
          # Get commit info
          COMMIT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:%Y%m%d-%H%M%S)

          # Get current version from Cargo.toml
          BASE_VERSION=$(grep '^version =' Cargo.toml | cut -d'"' -f2 | cut -d'-' -f1)

          # Create nightly version
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.${COMMIT_DATE}-${COMMIT_SHA}"

          echo "version=${NIGHTLY_VERSION}" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "commit_date=${COMMIT_DATE}" >> $GITHUB_OUTPUT
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT

          echo "Building nightly version: ${NIGHTLY_VERSION}"

      - name: Update version in Cargo.toml
        run: |
          sed -i "s/^version = \".*\"/version = \"${{ steps.version.outputs.version }}\"/" Cargo.toml
          cat Cargo.toml | grep '^version ='

      - name: Update Cargo.lock
        run: |
          cargo update --package repolens

      - name: Build release binary
        run: |
          cargo build --release --locked
          strip target/release/repolens || true

      - name: Get binary info
        id: binary
        run: |
          BINARY_SIZE=$(stat -c%s target/release/repolens)
          BINARY_HASH=$(sha256sum target/release/repolens | cut -d' ' -f1)

          echo "size=${BINARY_SIZE}" >> $GITHUB_OUTPUT
          echo "hash=${BINARY_HASH}" >> $GITHUB_OUTPUT

          echo "Binary size: ${BINARY_SIZE} bytes"
          echo "Binary hash: ${BINARY_HASH}"

      - name: Create checksums
        run: |
          cd target/release
          sha256sum repolens > repolens.sha256
          sha512sum repolens > repolens.sha512
          md5sum repolens > repolens.md5

      - name: Create archive
        run: |
          cd target/release
          tar czf repolens-linux-x86_64.tar.gz repolens repolens.sha256 repolens.sha512 repolens.md5
          zip repolens-linux-x86_64.zip repolens repolens.sha256 repolens.sha512 repolens.md5

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: repolens-nightly-linux-x86_64
          path: |
            target/release/repolens
            target/release/repolens.sha256
            target/release/repolens.sha512
            target/release/repolens.md5
            target/release/repolens-linux-x86_64.tar.gz
            target/release/repolens-linux-x86_64.zip
          retention-days: 30

      - name: Create Nightly Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ steps.version.outputs.commit_date }}-${{ steps.version.outputs.commit_sha }}
          name: Nightly Build ${{ steps.version.outputs.commit_date }}
          body: |
            ## Nightly Build

            **Version:** ${{ steps.version.outputs.version }}
            **Commit:** ${{ steps.version.outputs.commit_sha }}
            **Date:** ${{ steps.version.outputs.commit_date }}

            ### Binary Information
            - **Size:** ${{ steps.binary.outputs.size }} bytes
            - **SHA256:** `${{ steps.binary.outputs.hash }}`

            ### Downloads
            - Binary: `repolens`
            - Archive (tar.gz): `repolens-linux-x86_64.tar.gz`
            - Archive (zip): `repolens-linux-x86_64.zip`
            - Checksums: `repolens.sha256`, `repolens.sha512`, `repolens.md5`

            > ⚠️ This is a nightly build. Use at your own risk.
            > For stable releases, see the [Releases](https://github.com/${{ github.repository }}/releases) page.
          files: |
            target/release/repolens
            target/release/repolens.sha256
            target/release/repolens.sha512
            target/release/repolens.md5
            target/release/repolens-linux-x86_64.tar.gz
            target/release/repolens-linux-x86_64.zip
          draft: false
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}

  # Notification si le build est ignoré
  skip-notification:
    name: Skip Notification
    runs-on: ubuntu-latest
    needs: [check-prerequisites]
    if: needs.check-prerequisites.outputs.should_build == 'false'
    steps:
      - name: Log skip reason
        run: |
          echo "## Nightly Build Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The nightly build was skipped because one of the following conditions was not met:" >> $GITHUB_STEP_SUMMARY
          echo "- No changes since last nightly build" >> $GITHUB_STEP_SUMMARY
          echo "- CI workflow did not succeed" >> $GITHUB_STEP_SUMMARY
          echo "- Code Quality workflow did not succeed" >> $GITHUB_STEP_SUMMARY
