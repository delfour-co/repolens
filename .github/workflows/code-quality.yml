name: Code Quality & Technical Debt Analysis

on:
  # DÃ©clenchÃ© aprÃ¨s que CI soit terminÃ© avec succÃ¨s
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - master
  # Peut aussi Ãªtre dÃ©clenchÃ© manuellement ou sur push/PR
  workflow_dispatch:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # ExÃ©cution hebdomadaire pour suivre l'Ã©volution de la dette technique
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always

jobs:
  # VÃ©rification que CI a rÃ©ussi avant de lancer l'analyse de qualitÃ©
  check-ci-success:
    name: Check CI Success
    runs-on: ubuntu-latest
    # S'exÃ©cute toujours, mais vÃ©rifie CI seulement si dÃ©clenchÃ© par workflow_run
    if: always()
    steps:
      - name: Verify CI passed (workflow_run only)
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI workflow did not succeed. Skipping code quality analysis."
            exit 1
          fi
          echo "âœ… CI workflow passed. Proceeding with code quality analysis."
      - name: Skip CI check (other triggers)
        if: github.event_name != 'workflow_run'
        run: |
          echo "â„¹ï¸ Not triggered by CI workflow. Proceeding with code quality analysis."
  # Analyse avec cargo-deny (licences, vulnÃ©rabilitÃ©s, dÃ©pendances)
  dependency-audit:
    name: Dependency Audit (cargo-deny)
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Check licenses
        run: cargo deny check licenses
        continue-on-error: true
      - name: Check bans (duplicate dependencies)
        run: cargo deny check bans
        continue-on-error: true
      - name: Check sources
        run: cargo deny check sources
        continue-on-error: true
      - name: Check advisories (vulnerabilities)
        run: cargo deny check advisories
        continue-on-error: true

  # Audit de sÃ©curitÃ© avec cargo-audit
  security-audit:
    name: Security Audit (cargo-audit)
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run security audit
        run: cargo audit
        continue-on-error: true

  # DÃ©tection des dÃ©pendances obsolÃ¨tes
  outdated-dependencies:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      - name: Check for outdated dependencies
        run: cargo outdated --exit-code 1
        continue-on-error: true

  # Analyse Clippy avancÃ©e avec mÃ©triques
  clippy-analysis:
    name: Clippy Analysis
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run Clippy with all lints
        run: |
          cargo clippy --all-targets --all-features -- \
            -W clippy::all \
            -W clippy::pedantic \
            -W clippy::nursery \
            -W clippy::cargo \
            -D warnings \
            --message-format=json | tee clippy.json || true
        continue-on-error: true
      - name: Upload Clippy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: clippy-results
          path: clippy.json
          retention-days: 30

  # Analyse de complexitÃ© cyclomatique et mÃ©triques de code
  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-geiger
        run: cargo install cargo-geiger --locked
        continue-on-error: true
      - name: Generate unsafe code report
        run: cargo geiger --all-features --format json --output geiger.json || true
        continue-on-error: true
      - name: Count lines of code
        run: |
          echo "## Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "### Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find src -name "*.rs" -exec wc -l {} + | tail -1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "### Number of Rust files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find src -name "*.rs" | wc -l >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Analyse de sÃ©curitÃ© avec Semgrep (alternative Ã  CodeQL pour Rust)
  # Semgrep supporte Rust nativement et peut dÃ©tecter des vulnÃ©rabilitÃ©s de sÃ©curitÃ©
  # Avantages par rapport Ã  CodeQL : open source, plus rapide, fonctionne sans compilation
  semgrep-analysis:
    name: Semgrep Security Analysis
    runs-on: ubuntu-latest
    needs: [check-ci-success]
    if: always() && (needs.check-ci-success.result == 'success' || needs.check-ci-success.result == 'skipped')
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep scan
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/rust
            p/owasp-top-ten
          generateSarif: "1"
        continue-on-error: true
      - name: Upload SARIF file to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true

  # Alternative : CodeQL avec support Rust (si disponible)
  # Note: CodeQL peut analyser Rust mais nÃ©cessite une configuration spÃ©cifique
  # DÃ©commentez si vous prÃ©fÃ©rez CodeQL Ã  Semgrep
  # codeql-analysis:
  #   name: CodeQL Analysis
  #   runs-on: ubuntu-latest
  #   permissions:
  #     actions: read
  #     contents: read
  #     security-events: write
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: dtolnay/rust-toolchain@stable
  #     - uses: Swatinem/rust-cache@v2
  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v4
  #       with:
  #         languages: rust
  #         queries: security-and-quality
  #     - name: Autobuild
  #       uses: github/codeql-action/autobuild@v4
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v4

  # SonarCloud (optionnel - nÃ©cessite configuration)
  # DÃ©commentez et configurez si vous avez un compte SonarCloud
  # sonarcloud:
  #   name: SonarCloud Analysis
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0  # Shallow clones should be disabled for better analysis
  #     - uses: dtolnay/rust-toolchain@stable
  #     - uses: Swatinem/rust-cache@v2
  #     - name: Install cargo-sonar
  #       run: cargo install cargo-sonar --locked
  #     - name: Run Clippy for SonarCloud
  #       run: cargo clippy --all-targets --all-features --message-format=json > clippy.json
  #     - name: SonarCloud Scan
  #       uses: SonarSource/sonarcloud-github-action@master
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Rapport de qualitÃ© consolidÃ©
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [check-ci-success, dependency-audit, security-audit, outdated-dependencies, clippy-analysis, code-metrics, semgrep-analysis]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Generate quality report
        run: |
          echo "# ðŸ“Š Rapport de QualitÃ© du Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Analyses effectuÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Audit des dÃ©pendances (cargo-deny)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Audit de sÃ©curitÃ© (cargo-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DÃ©tection des dÃ©pendances obsolÃ¨tes (cargo-outdated)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analyse Clippy avancÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MÃ©triques de code" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analyse de sÃ©curitÃ© Semgrep (Rust)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consultez les dÃ©tails dans chaque job ci-dessus." >> $GITHUB_STEP_SUMMARY
