name: Code Quality & Technical Debt Analysis

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    # ExÃ©cution hebdomadaire pour suivre l'Ã©volution de la dette technique
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Analyse avec cargo-deny (licences, vulnÃ©rabilitÃ©s, dÃ©pendances)
  dependency-audit:
    name: Dependency Audit (cargo-deny)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Check licenses
        run: cargo deny check licenses
        continue-on-error: true
      - name: Check bans (duplicate dependencies)
        run: cargo deny check bans
        continue-on-error: true
      - name: Check sources
        run: cargo deny check sources
        continue-on-error: true
      - name: Check advisories (vulnerabilities)
        run: cargo deny check advisories
        continue-on-error: true

  # Audit de sÃ©curitÃ© avec cargo-audit
  security-audit:
    name: Security Audit (cargo-audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
      - name: Run security audit
        run: cargo audit
        continue-on-error: true

  # DÃ©tection des dÃ©pendances obsolÃ¨tes
  outdated-dependencies:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      - name: Check for outdated dependencies
        run: cargo outdated --exit-code 1
        continue-on-error: true

  # Analyse Clippy avancÃ©e avec mÃ©triques
  clippy-analysis:
    name: Clippy Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Run Clippy with all lints
        run: |
          cargo clippy --all-targets --all-features -- \
            -W clippy::all \
            -W clippy::pedantic \
            -W clippy::nursery \
            -W clippy::cargo \
            -D warnings \
            --message-format=json | tee clippy.json || true
        continue-on-error: true
      - name: Upload Clippy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: clippy-results
          path: clippy.json
          retention-days: 30

  # Analyse de complexitÃ© cyclomatique et mÃ©triques de code
  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-geiger
        run: cargo install cargo-geiger --locked
        continue-on-error: true
      - name: Generate unsafe code report
        run: cargo geiger --all-features --format json --output geiger.json || true
        continue-on-error: true
      - name: Count lines of code
        run: |
          echo "## Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "### Lines of Code" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find src -name "*.rs" -exec wc -l {} + | tail -1 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "### Number of Rust files" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find src -name "*.rs" | wc -l >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # GitHub Code Scanning avec CodeQL (dÃ©tection de vulnÃ©rabilitÃ©s)
  # Note: CodeQL ne supporte pas Rust nativement, mais peut analyser les fichiers de configuration
  # et dÃ©tecter des problÃ¨mes dans les scripts shell, YAML, etc.
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          # CodeQL peut analyser les fichiers de configuration et scripts
          languages: javascript, yaml, bash
          queries: security-and-quality
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # SonarCloud (optionnel - nÃ©cessite configuration)
  # DÃ©commentez et configurez si vous avez un compte SonarCloud
  # sonarcloud:
  #   name: SonarCloud Analysis
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0  # Shallow clones should be disabled for better analysis
  #     - uses: dtolnay/rust-toolchain@stable
  #     - uses: Swatinem/rust-cache@v2
  #     - name: Install cargo-sonar
  #       run: cargo install cargo-sonar --locked
  #     - name: Run Clippy for SonarCloud
  #       run: cargo clippy --all-targets --all-features --message-format=json > clippy.json
  #     - name: SonarCloud Scan
  #       uses: SonarSource/sonarcloud-github-action@master
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Rapport de qualitÃ© consolidÃ©
  quality-report:
    name: Quality Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, security-audit, outdated-dependencies, clippy-analysis, code-metrics]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Generate quality report
        run: |
          echo "# ðŸ“Š Rapport de QualitÃ© du Code" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Analyses effectuÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Audit des dÃ©pendances (cargo-deny)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Audit de sÃ©curitÃ© (cargo-audit)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DÃ©tection des dÃ©pendances obsolÃ¨tes (cargo-outdated)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analyse Clippy avancÃ©e" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MÃ©triques de code" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Analyse de sÃ©curitÃ© CodeQL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consultez les dÃ©tails dans chaque job ci-dessus." >> $GITHUB_STEP_SUMMARY
