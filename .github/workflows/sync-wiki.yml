name: Sync Wiki

on:
  workflow_run:
    workflows: ["Nightly Build", "Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type de version pour les badges'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - stable

permissions:
  contents: read

jobs:
  sync-wiki:
    name: Synchroniser le WIKI
    runs-on: ubuntu-latest
    # ExÃ©cuter seulement si le workflow dÃ©clencheur a rÃ©ussi (ou si c'est un dÃ©clenchement manuel)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Afficher les informations du dÃ©clencheur
        run: |
          echo "ðŸ“‹ Informations du dÃ©clenchement:"
          echo "   - Ã‰vÃ©nement: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "   - Workflow source: ${{ github.event.workflow_run.name }}"
            echo "   - Conclusion: ${{ github.event.workflow_run.conclusion }}"
            echo "   - Branche: ${{ github.event.workflow_run.head_branch }}"
            echo "   - Commit: ${{ github.event.workflow_run.head_sha }}"
          else
            echo "   - DÃ©clenchement manuel"
            echo "   - Type de version: ${{ github.event.inputs.version_type }}"
          fi

      - name: VÃ©rifier le secret WIKI_PAT
        run: |
          if [ -z "${{ secrets.WIKI_PAT }}" ]; then
            echo "âŒ Le secret WIKI_PAT n'est pas configurÃ©!"
            echo ""
            echo "ðŸ“ Instructions pour crÃ©er le PAT:"
            echo "   1. Aller sur https://github.com/settings/tokens"
            echo "   2. Cliquer sur 'Generate new token (classic)'"
            echo "   3. Donner un nom: 'Wiki Sync PAT'"
            echo "   4. SÃ©lectionner le scope 'repo' (Full control of private repositories)"
            echo "   5. GÃ©nÃ©rer et copier le token"
            echo ""
            echo "ðŸ“ Instructions pour ajouter le secret:"
            echo "   1. Aller dans Settings > Secrets and variables > Actions"
            echo "   2. Cliquer sur 'New repository secret'"
            echo "   3. Nom: WIKI_PAT"
            echo "   4. Valeur: coller le token crÃ©Ã©"
            echo ""
            exit 1
          fi
          echo "âœ… Secret WIKI_PAT trouvÃ©"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: DÃ©terminer le type de version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
          elif [ "${{ github.event.workflow_run.name }}" = "Release" ]; then
            VERSION_TYPE="stable"
          else
            VERSION_TYPE="nightly"
          fi

          echo "version_type=${VERSION_TYPE}" >> $GITHUB_OUTPUT

          # DÃ©finir les badges selon le type
          if [ "$VERSION_TYPE" = "stable" ]; then
            echo "badge_color=green" >> $GITHUB_OUTPUT
            echo "badge_label=stable" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Version: Stable (Release)"
          else
            echo "badge_color=orange" >> $GITHUB_OUTPUT
            echo "badge_label=nightly" >> $GITHUB_OUTPUT
            echo "ðŸŒ™ Version: Nightly"
          fi

      - name: Configurer Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: VÃ©rifier que le WIKI est activÃ©
        id: check-wiki
        env:
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"

          echo "ðŸ” VÃ©rification du WIKI: ${WIKI_REPO}"

          if git ls-remote "https://x-access-token:${WIKI_PAT}@github.com/${WIKI_REPO}.git" &>/dev/null; then
            echo "wiki_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… WIKI trouvÃ© et accessible"
          else
            echo "wiki_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  WIKI non trouvÃ© ou non activÃ©"
            echo "ðŸ’¡ Activez le WIKI dans Settings > Features > Wikis"
          fi

      - name: Cloner ou initialiser le WIKI
        id: setup-wiki
        env:
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"
          WIKI_DIR=$(mktemp -d)
          echo "WIKI_DIR=${WIKI_DIR}" >> $GITHUB_ENV

          echo "ðŸ“¥ Tentative de clonage du WIKI..."
          if git clone "https://x-access-token:${WIKI_PAT}@github.com/${WIKI_REPO}.git" "$WIKI_DIR" 2>&1; then
            echo "âœ… WIKI clonÃ© avec succÃ¨s"
            echo "wiki_initialized=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ WIKI vide ou non initialisÃ©, crÃ©ation d'un nouveau dÃ©pÃ´t..."
            mkdir -p "$WIKI_DIR"
            cd "$WIKI_DIR"
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote add origin "https://x-access-token:${WIKI_PAT}@github.com/${WIKI_REPO}.git"
            echo "wiki_initialized=false" >> $GITHUB_OUTPUT
            echo "âœ… DÃ©pÃ´t WIKI initialisÃ© localement"
          fi

          echo "ðŸ“‚ Dossier WIKI: ${WIKI_DIR}"
          ls -la "$WIKI_DIR" || echo "Dossier vide"

      - name: Synchroniser les pages avec badges
        env:
          VERSION_TYPE: ${{ steps.version.outputs.version_type }}
          BADGE_COLOR: ${{ steps.version.outputs.badge_color }}
          BADGE_LABEL: ${{ steps.version.outputs.badge_label }}
        run: |
          echo "ðŸ”„ Synchronisation des pages..."
          echo "ðŸ“‚ Pages disponibles dans wiki/:"
          ls -la wiki/*.md 2>/dev/null || echo "Aucune page trouvÃ©e dans wiki/"

          UPDATED=0
          CREATED=0

          # Date de mise Ã  jour
          UPDATE_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")

          # Fonction pour ajouter le header avec badges
          add_header() {
            local file="$1"
            local page_name="$2"
            local temp_file=$(mktemp)

            # CrÃ©er le header
            cat > "$temp_file" << EOF
<!-- Auto-generated header - Do not edit manually -->
![Version](https://img.shields.io/badge/version-${VERSION_TYPE}-${BADGE_COLOR})
![Updated](https://img.shields.io/badge/updated-$(echo "${UPDATE_DATE}" | sed 's/ /%20/g')-blue)

---

EOF

            # Supprimer l'ancien header s'il existe (entre les marqueurs)
            if grep -q "<!-- Auto-generated header" "$file"; then
              # Extraire le contenu aprÃ¨s le marqueur de fin de header (---)
              sed -n '/^<!-- Auto-generated header/,/^---$/d; p' "$file" >> "$temp_file"
            else
              # Pas de header existant, ajouter le contenu complet
              cat "$file" >> "$temp_file"
            fi

            mv "$temp_file" "$file"
          }

          # Copier toutes les pages du dossier wiki/ vers le WIKI
          for page in wiki/*.md; do
            if [ -f "$page" ]; then
              page_name=$(basename "$page")

              # Ignorer README.md du dossier wiki
              if [ "$page_name" = "README.md" ]; then
                echo "  â­ï¸  IgnorÃ© (README.md du dossier wiki): $page_name"
                continue
              fi

              # Copier le fichier
              cp "$page" "$WIKI_DIR/$page_name"

              # Ajouter le header avec badges
              add_header "$WIKI_DIR/$page_name" "$page_name"

              if [ -f "$WIKI_DIR/.git/index" ]; then
                # VÃ©rifier si le fichier a changÃ© dans git
                cd "$WIKI_DIR"
                if git diff --quiet "$page_name" 2>/dev/null; then
                  echo "  âœ“  DÃ©jÃ  Ã  jour: $page_name"
                  cd - > /dev/null
                else
                  echo "  âœï¸  Mise Ã  jour: $page_name"
                  UPDATED=$((UPDATED + 1))
                  cd - > /dev/null
                fi
              else
                echo "  âž• CrÃ©ation: $page_name"
                CREATED=$((CREATED + 1))
              fi
            fi
          done

          echo "UPDATED=${UPDATED}" >> $GITHUB_ENV
          echo "CREATED=${CREATED}" >> $GITHUB_ENV
          echo "ðŸ“Š RÃ©sumÃ©: ${CREATED} crÃ©Ã©e(s), ${UPDATED} mise(s) Ã  jour"

      - name: Commit et push les changements
        env:
          WIKI_PAT: ${{ secrets.WIKI_PAT }}
          VERSION_TYPE: ${{ steps.version.outputs.version_type }}
        run: |
          cd "$WIKI_DIR"

          echo "ðŸ“‹ Ã‰tat du dÃ©pÃ´t WIKI:"
          git status || echo "DÃ©pÃ´t non initialisÃ©"

          # VÃ©rifier s'il y a des changements
          if [ -n "$(git status --porcelain 2>/dev/null)" ] || [ "${{ steps.setup-wiki.outputs.wiki_initialized }}" = "false" ]; then
            echo "ðŸ“ PrÃ©paration du commit..."
            git add -A

            # Construire le message de commit
            if [ "$VERSION_TYPE" = "stable" ]; then
              COMMIT_MSG="ðŸ“¦ Sync Wiki - Release stable"
            else
              COMMIT_MSG="ðŸŒ™ Sync Wiki - Nightly build"
            fi

            echo "ðŸ’¾ CrÃ©ation du commit..."
            git commit -m "$COMMIT_MSG" \
              -m "" \
              -m "- Version: ${VERSION_TYPE}" \
              -m "- Source: ${{ github.event.workflow_run.name || 'Manual trigger' }}" \
              -m "- Commit: ${{ github.event.workflow_run.head_sha || github.sha }}" \
              -m "- Date: $(date -Iseconds)" || {
              echo "âš ï¸  Ã‰chec du commit (peut-Ãªtre aucun changement rÃ©el)"
              git status
              exit 0
            }

            # DÃ©terminer la branche par dÃ©faut
            DEFAULT_BRANCH="main"
            echo "ðŸ” VÃ©rification de la branche par dÃ©faut..."

            if git ls-remote --heads origin "$DEFAULT_BRANCH" 2>/dev/null | grep -q "$DEFAULT_BRANCH"; then
              echo "âœ… Branche 'main' trouvÃ©e"
            elif git ls-remote --heads origin "master" 2>/dev/null | grep -q "master"; then
              DEFAULT_BRANCH="master"
              echo "âœ… Branche 'master' trouvÃ©e"
            else
              echo "ðŸ“ Aucune branche existante, utilisation de 'main' (premier push)"
            fi

            echo "ðŸ“¤ Push vers GitHub (branche: ${DEFAULT_BRANCH})..."

            REPO="${{ github.repository }}"
            WIKI_URL="https://x-access-token:${WIKI_PAT}@github.com/${REPO}.wiki.git"

            if [ "${{ steps.setup-wiki.outputs.wiki_initialized }}" = "false" ]; then
              echo "ðŸš€ Premier push du WIKI..."
              git push -u "$WIKI_URL" HEAD:${DEFAULT_BRANCH} 2>&1 || {
                echo "âŒ Ã‰chec du push"
                echo "ðŸ’¡ VÃ©rifiez que le WIKI est activÃ© dans Settings > Features > Wikis"
                exit 1
              }
            else
              git push "$WIKI_URL" HEAD:${DEFAULT_BRANCH} 2>&1 || {
                echo "âŒ Ã‰chec du push"
                exit 1
              }
            fi

            echo "âœ… WIKI synchronisÃ© avec succÃ¨s!"
            echo "   - Version: ${VERSION_TYPE}"
            echo "   - Branche: ${DEFAULT_BRANCH}"
          else
            echo "â„¹ï¸  Aucun changement dÃ©tectÃ© dans le dÃ©pÃ´t WIKI"
          fi

      - name: VÃ©rification finale
        if: always()
        run: |
          echo "ðŸ“Š RÃ©sumÃ© de la synchronisation:"
          echo "   - Type de version: ${{ steps.version.outputs.version_type }}"
          echo "   - Pages crÃ©Ã©es: ${CREATED:-0}"
          echo "   - Pages mises Ã  jour: ${UPDATED:-0}"

          if [ "${CREATED:-0}" -eq 0 ] && [ "${UPDATED:-0}" -eq 0 ]; then
            echo ""
            echo "âš ï¸  Aucune page n'a Ã©tÃ© synchronisÃ©e"
            echo "ðŸ’¡ VÃ©rifiez que:"
            echo "   1. Le dossier wiki/ contient des fichiers .md (sauf README.md)"
            echo "   2. Le WIKI est activÃ© dans Settings > Features > Wikis"
          fi

          echo ""
          echo "ðŸ”— Wiki URL: https://github.com/${{ github.repository }}/wiki"
