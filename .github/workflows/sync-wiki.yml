name: Sync Wiki

on:
  push:
    branches: [main, master]
    paths:
      - 'wiki/**'
      - 'README.md'
      - 'DEVELOPMENT.md'
      - 'CHANGELOG.md'
      - '.github/workflows/sync-wiki.yml'
  workflow_dispatch:  # Permet de d√©clencher manuellement

permissions:
  contents: write  # N√©cessaire pour pousser vers le WIKI

jobs:
  sync-wiki:
    name: Synchroniser le WIKI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # N√©cessaire pour avoir l'historique Git complet
      
      - name: Configurer Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: V√©rifier que le WIKI est activ√©
        id: check-wiki
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"
          
          echo "üîç V√©rification du WIKI: ${WIKI_REPO}"
          
          # V√©rifier si le WIKI existe en essayant de le cloner
          if git ls-remote "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${WIKI_REPO}.git" &>/dev/null; then
            echo "wiki_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ WIKI trouv√© et accessible: ${WIKI_REPO}"
          else
            # Le WIKI peut ne pas exister encore ou ne pas √™tre activ√©
            # On va quand m√™me essayer de le cr√©er
            echo "wiki_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  WIKI non trouv√© ou non activ√©: ${WIKI_REPO}"
            echo "‚ö†Ô∏è  Le workflow va essayer de cr√©er le WIKI"
            echo "‚ö†Ô∏è  Si cela √©choue, activez le WIKI dans Settings > Features > Wikis"
          fi
      
      - name: Cloner ou initialiser le WIKI
        id: setup-wiki
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"
          WIKI_DIR=$(mktemp -d)
          echo "WIKI_DIR=${WIKI_DIR}" >> $GITHUB_ENV
          
          echo "üì• Tentative de clonage du WIKI..."
          if git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${WIKI_REPO}.git" "$WIKI_DIR" 2>&1; then
            echo "‚úÖ WIKI clon√© avec succ√®s"
            echo "wiki_initialized=true" >> $GITHUB_OUTPUT
          else
            echo "üìù WIKI vide ou non initialis√©, cr√©ation d'un nouveau d√©p√¥t..."
            mkdir -p "$WIKI_DIR"
            cd "$WIKI_DIR"
            git init
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${WIKI_REPO}.git"
            echo "wiki_initialized=false" >> $GITHUB_OUTPUT
            echo "‚úÖ D√©p√¥t WIKI initialis√© localement"
          fi
          
          echo "üìÇ Dossier WIKI: ${WIKI_DIR}"
          ls -la "$WIKI_DIR" || echo "Dossier vide"
      
      - name: Synchroniser les pages
        run: |
          echo "üîÑ Synchronisation des pages..."
          echo "üìÇ Pages disponibles dans wiki/:"
          ls -la wiki/*.md 2>/dev/null || echo "Aucune page trouv√©e dans wiki/"
          
          UPDATED=0
          CREATED=0
          
          # Copier toutes les pages du dossier wiki/ vers le WIKI
          for page in wiki/*.md; do
            if [ -f "$page" ]; then
              page_name=$(basename "$page")
              
              # Ignorer README.md du dossier wiki
              if [ "$page_name" = "README.md" ]; then
                echo "  ‚è≠Ô∏è  Ignor√© (README.md du dossier wiki): $page_name"
                continue
              fi
              
              if [ -f "$WIKI_DIR/$page_name" ]; then
                # V√©rifier si le contenu a chang√©
                if ! cmp -s "$page" "$WIKI_DIR/$page_name"; then
                  cp "$page" "$WIKI_DIR/$page_name"
                  echo "  ‚úèÔ∏è  Mise √† jour: $page_name"
                  ((UPDATED++))
                else
                  echo "  ‚úì  D√©j√† √† jour: $page_name"
                fi
              else
                cp "$page" "$WIKI_DIR/$page_name"
                echo "  ‚ûï Cr√©ation: $page_name"
                ((CREATED++))
              fi
            fi
          done
          
          echo "UPDATED=${UPDATED}" >> $GITHUB_ENV
          echo "CREATED=${CREATED}" >> $GITHUB_ENV
          echo "üìä R√©sum√©: ${CREATED} cr√©√©e(s), ${UPDATED} mise(s) √† jour"
      
      - name: Commit et push les changements
        if: env.UPDATED > 0 || env.CREATED > 0
        run: |
          cd "$WIKI_DIR"
          
          echo "üìã √âtat du d√©p√¥t WIKI:"
          git status || echo "D√©p√¥t non initialis√©"
          
          # V√©rifier s'il y a des changements
          if [ -n "$(git status --porcelain 2>/dev/null)" ] || [ "${{ steps.setup-wiki.outputs.wiki_initialized }}" = "false" ]; then
            echo "üìù Pr√©paration du commit..."
            git add -A
            
            echo "üíæ Cr√©ation du commit..."
            git commit -m "üîÑ Synchronisation automatique du WIKI" \
              -m "" \
              -m "- Mise √† jour depuis le d√©p√¥t principal" \
              -m "- Commit source: ${{ github.sha }}" \
              -m "- Workflow: ${{ github.workflow }}" \
              -m "- D√©clench√© par: ${{ github.actor }}" \
              -m "- Date: $(date -Iseconds)" || {
              echo "‚ö†Ô∏è  √âchec du commit (peut-√™tre aucun changement r√©el)"
              git status
              exit 0
            }
            
            # D√©terminer la branche par d√©faut
            DEFAULT_BRANCH="main"
            echo "üîç V√©rification de la branche par d√©faut..."
            
            # V√©rifier quelle branche existe
            if git ls-remote --heads origin "$DEFAULT_BRANCH" 2>/dev/null | grep -q "$DEFAULT_BRANCH"; then
              echo "‚úÖ Branche 'main' trouv√©e"
            elif git ls-remote --heads origin "master" 2>/dev/null | grep -q "master"; then
              DEFAULT_BRANCH="master"
              echo "‚úÖ Branche 'master' trouv√©e"
            else
              echo "üìù Aucune branche existante, utilisation de 'main' (premier push)"
            fi
            
            echo "üì§ Push vers GitHub (branche: ${DEFAULT_BRANCH})..."
            echo "üîó URL: https://github.com/${{ github.repository }}.wiki.git"
            
            # Premier push ou push normal
            if [ "${{ steps.setup-wiki.outputs.wiki_initialized }}" = "false" ]; then
              echo "üöÄ Premier push du WIKI..."
              git push -u "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" HEAD:${DEFAULT_BRANCH} 2>&1 || {
                echo "‚ùå √âchec du push"
                echo "üí° V√©rifiez que:"
                echo "   1. Le WIKI est activ√© dans Settings > Features > Wikis"
                echo "   2. Les permissions sont correctes"
                echo "   3. Le token GITHUB_TOKEN a les droits n√©cessaires"
                exit 1
              }
            else
              git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" HEAD:${DEFAULT_BRANCH} 2>&1 || {
                echo "‚ùå √âchec du push"
                exit 1
              }
            fi
            
            echo "‚úÖ WIKI synchronis√© avec succ√®s!"
            echo "   - Pages cr√©√©es: ${CREATED}"
            echo "   - Pages mises √† jour: ${UPDATED}"
            echo "   - Branche: ${DEFAULT_BRANCH}"
          else
            echo "‚ÑπÔ∏è  Aucun changement d√©tect√© dans le d√©p√¥t WIKI"
          fi
      
      - name: V√©rification finale
        if: always()
        run: |
          echo "üìä R√©sum√© de la synchronisation:"
          echo "   - Pages cr√©√©es: ${CREATED:-0}"
          echo "   - Pages mises √† jour: ${UPDATED:-0}"
          
          if [ "${CREATED:-0}" -eq 0 ] && [ "${UPDATED:-0}" -eq 0 ]; then
            echo "‚ö†Ô∏è  Aucune page n'a √©t√© synchronis√©e"
            echo "üí° V√©rifiez que:"
            echo "   1. Le dossier wiki/ contient des fichiers .md (sauf README.md)"
            echo "   2. Le WIKI est activ√© dans Settings > Features > Wikis"
            echo "   3. Les fichiers ont bien √©t√© modifi√©s dans le commit"
          fi
